name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Dependency Security Check
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: moderate

  # Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project

      - name: Run Composer Security Audit
        run: composer audit --format=plain

  # PHP Tests with Coverage
  php-tests:
    name: PHP Tests & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project
        with:
          php-version: '8.4'
          extensions: 'ctype, iconv, pdo, pdo_sqlite, mbstring, xml, intl, zip'
          coverage: pcov

      - name: Validate composer files
        run: composer validate --no-check-publish

      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Build frontend assets
        run: npm run build

      - name: Prepare Laravel Application
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run PHPUnit Tests with Coverage
        run: vendor/bin/phpunit --coverage-clover coverage.xml --testdox

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check code coverage threshold
        run: |
          COVERAGE=$(php -r "
          \$xml = simplexml_load_file('coverage.xml');
          \$metrics = \$xml->project->metrics;
          \$lines = (int)\$metrics['statements'];
          \$covered = (int)\$metrics['coveredstatements'];
          \$percentage = (\$lines > 0) ? (\$covered / \$lines) * 100 : 0;
          echo number_format(\$percentage, 2);
          ")
          echo "Code coverage (line): ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 74" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below 74% threshold"
            exit 1
          fi
          echo "âœ… Coverage ${COVERAGE}% meets 74% threshold"

  # PHP Code Style (Laravel Pint)
  code-style:
    name: Code Style (Pint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project

      - name: Run Laravel Pint
        run: composer pint-test

  # Static Analysis (PHPStan)
  static-analysis:
    name: Static Analysis (PHPStan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project
        with:
          extensions: 'ctype, iconv, pdo, pdo_sqlite, mbstring, xml, intl, zip'

      - name: Run PHPStan Analysis
        run: composer phpstan

  # Rector Refactoring Check (Non-blocking)
  rector-check:
    name: Rector Suggestions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project
        with:
          extensions: 'ctype, iconv, pdo, pdo_sqlite, mbstring, xml, intl, zip'

      - name: Run Rector in Dry-Run mode
        run: vendor/bin/rector process --dry-run --ansi
        continue-on-error: true

  # Frontend Build & Validation
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Build frontend assets
        run: npm run build

      - name: Verify build artifacts
        run: |
          if [ ! -d "public/build" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          echo "âœ… Frontend build completed successfully"

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh public/build | cut -f1)
          echo "ðŸ“¦ Build size: $BUILD_SIZE"

      - name: Cache build artifacts
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: public/build
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-
